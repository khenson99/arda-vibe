# Ralph Team Loop — Progress Log
# This file is appended to by every agent after each iteration.
# It serves as cumulative memory across fresh-context Ralph iterations.
# =====================================================================


--- Backend Agent Iteration 3 | Issue #111 ---
Timestamp: 2026-02-11T08:16:00Z
Status: completed
Changes:
  - packages/db/src/schema/users.ts (added apiKeys table with relations)
  - packages/db/src/schema/tenants.ts (added webhook fields to TenantSettings)
  - services/auth/src/services/integration.service.ts (new)
  - services/auth/src/services/integration.service.test.ts (new, 14 tests passing)
  - services/auth/src/routes/integrations.routes.ts (new)
  - services/auth/src/index.ts (registered users and integrations routers)
  - services/api-gateway/src/routes/proxy.ts (added /api/users and /api/integrations routes)
Tests: 14 new integration tests, all passing
Learnings:
  - Integration settings backend complete: API key management + webhook configuration
  - API keys use crypto.randomBytes for secure generation, SHA-256 for hashing
  - Key format: arda_<8hex-prefix>_<64hex-secret>, only full key shown on creation
  - Webhook settings stored in tenant.settings JSONB: webhookUrl, webhookSecret, webhookEvents
  - Security: never return webhookSecret in GET responses, only indicate presence with hasWebhookSecret
  - Schema patterns: apiKeys table in auth schema with foreign keys to tenants and users
  - Relations: added apiKeys to usersRelations for Drizzle relational queries
  - All routes require tenant_admin role via requireRole() middleware
  - Gateway routing: both /api/users and /api/integrations proxy to auth service
  - Test patterns: mock crypto functions would require vi.mock('crypto'), accepted test behavior for actual crypto use

--- Backend Agent Iteration 1 | Issue #250 ---
Timestamp: 2026-02-12T01:50:00Z
Status: completed
Changes:
  - packages/db/src/schema/audit.ts (added hashChain, previousHash, sequenceNumber columns + 2 new indexes)
  - packages/db/drizzle/0008_audit_hash_chain.sql (new — 3-phase migration: add columns → backfill → enforce constraints)
  - packages/db/drizzle/meta/_journal.json (registered migration 0008)
  - packages/db/src/migrations/audit-hash-chain.test.ts (new — 14 tests for idempotency, structure, hash computation, schema exports)
Tests: 14 new migration tests + 5 existing audit route tests, all passing (19 total)
Learnings:
  - Hash-chain columns: hash_chain (varchar 64, NOT NULL), previous_hash (varchar 64, nullable), sequence_number (bigint, NOT NULL)
  - Migration pattern: 3-phase for safe production deploy (nullable add → backfill → enforce NOT NULL + indexes)
  - Backfill uses recursive CTE to chain SHA-256 hashes sequentially per tenant
  - Deterministic tie-breaker ordering: (timestamp ASC, id ASC) prevents non-repeatable sequence assignment
  - First row per tenant uses 'GENESIS' sentinel instead of NULL for hash input consistency
  - Hash input format: tenant_id|seq|action|entity_type|entity_id|timestamp|previous_hash (pipe-delimited)
  - COALESCE(entity_id::text, '') handles NULL entity_id in hash computation
  - Idempotency: IF NOT EXISTS for columns/indexes, WHERE IS NULL for backfill targeting
  - Drizzle bigint mode: 'number' for sequence_number (JS safe integer range sufficient)
  - Index: (tenant_id, sequence_number DESC) for efficient latest-first per-tenant queries
  - Unique index on hash_chain ensures tamper-evidence
  - Existing GET /api/audit routes unaffected — new columns are additive in SELECT * responses
  - Rollback SQL documented in migration header comments

--- Backend Agent Iteration 2 | Issue #251 ---
Timestamp: 2026-02-12T02:00:00Z
Status: completed
Changes:
  - packages/db/src/schema/audit.ts (added auditLogArchive table with full schema parity to auditLog)
  - packages/db/src/schema/tenants.ts (added auditRetentionDays, auditArchiveEnabled to TenantSettings)
  - packages/db/drizzle/0009_audit_log_archive.sql (new — 3-phase: create partitioned table → attach 24 monthly partitions → create indexes)
  - packages/db/drizzle/meta/_journal.json (registered migration 0009)
  - packages/db/src/migrations/audit-log-archive.test.ts (new — 35 tests for schema parity, partitioning, indexes, idempotency)
Tests: 35 new migration tests + 22 existing, all 57 passing
PR: https://github.com/khenson99/arda-v2/pull/382
Learnings:
  - PostgreSQL range partitioning requires partition key in PK → composite PK (id, timestamp)
  - Drizzle doesn't model partitioning natively — all partition DDL must live in raw SQL migrations
  - DO $$ blocks with pg_catalog lookups enable idempotent partition creation
  - Partition naming convention: audit_log_archive_YYYY_MM for monthly partitions
  - Archive table id column uses plain uuid (no defaultRandom) — UUIDs are preserved from source
  - PostgreSQL auto-propagates indexes from partitioned parent to child partitions
  - 24 partitions (12 back + 12 forward) provides good coverage; cron/maintenance can extend
  - TenantSettings is a JSONB type interface — adding optional fields is non-breaking
  - Pre-existing frontend test failures in apps/web api-client.test.ts (2 tests) are unrelated to backend changes

--- Architect Iteration 2 ---
Timestamp: 2026-02-12T10:00:00Z
Tickets assigned: none (CI blocker must be resolved first)
Tickets completed: #251 code done, PR #382 open
Tickets blocked: #250 PR #381, #251 PR #382 — both failing CI (Lint & Typecheck)
Decisions made: ADR-003 (fix CI before proceeding to #252)
Learnings:
  - PRs #381 and #382 both fail CI: 30x TS2769 errors in @arda/orders-service
  - All errors are "No overload matches this call" in Drizzle query calls within orders service
  - Root cause: adding columns to audit schema in packages/db changed inferred Drizzle types, breaking orders service overload resolution
  - Main branch is green — errors are introduced by the audit schema changes
  - Files affected: order-queue.routes.ts, transfer-orders.routes.ts, 10 service files in services/orders
  - Fix: backend-engineer must update orders service type annotations to accommodate new audit columns
  - Both PRs share the same base issue; fix on #250 branch, rebase #251 on top
  - #252 (writeAuditEntry) can proceed in parallel on the same branch stack once CI fix is pushed

--- Backend Agent Iteration 3 | Issue #252 ---
Timestamp: 2026-02-12T14:00:00Z
Status: completed
Changes:
  - packages/db/src/schema/audit.ts (added .default('PENDING') / .default(0) to hashChain/sequenceNumber)
  - packages/db/drizzle/0010_audit_hash_chain_defaults.sql (new — adds SQL defaults for backward compat)
  - packages/db/drizzle/meta/_journal.json (registered migration 0010)
  - packages/db/src/audit-writer.ts (new — writeAuditEntry + writeAuditEntries with advisory lock, hash chain, sequence)
  - packages/db/src/audit-writer.test.ts (new — 24 tests: hash computation, DB interaction, batch writes, exports)
  - packages/db/src/index.ts (re-export writeAuditEntry, writeAuditEntries, AuditEntryInput, AuditEntryResult)
  - packages/db/package.json (added ./audit-writer export path)
  - packages/auth-utils/src/audit-context.ts (new — auditContextMiddleware for IP/UA extraction)
  - packages/auth-utils/src/audit-context.test.ts (new — 9 tests: IP extraction, user-agent, X-Forwarded-For, edge cases)
  - packages/auth-utils/src/index.ts (re-export auditContextMiddleware, AuditContext, AuditContextRequest)
Tests: 24 new audit-writer tests + 9 new audit-context tests = 33 new tests, all passing
  - db package: 78 total tests, all passing
  - auth-utils audit-context: 9/9 passing
  - orders service: 442/445 passing (3 pre-existing integration test failures)
  - kanban service: 256 passing (1 pre-existing auth-guards test file failure)
CI Fix:
  - Root cause: hashChain and sequenceNumber were NOT NULL with no default in Drizzle schema
  - Adding .default('PENDING') and .default(0) makes them optional in Drizzle's insert type
  - Migration 0010 adds matching SQL DEFAULTs for backward compat
  - All 30 TS2769 errors in orders service resolved without touching any service file
Learnings:
  - Advisory lock per tenant: pg_advisory_xact_lock(bigint) using first 16 hex of tenant UUID
  - Lock is transaction-scoped — auto-releases on commit/rollback
  - Hash input uses Date.toISOString() (JS-side) vs ::text (SQL-side) — important distinction
  - writeAuditEntries (batch) acquires lock + reads latest once, then chains sequentially
  - Drizzle .default() on NOT NULL columns makes the field optional in insert types
  - SQL DEFAULT + Drizzle .default() must match to keep schema and runtime in sync
  - 'PENDING' sentinel allows identifying legacy inserts that bypassed writeAuditEntry
  - auditContextMiddleware extracts IP from X-Forwarded-For (first entry) or socket.remoteAddress
  - Pattern: middleware attaches req.auditContext, route handlers spread it into writeAuditEntry call

--- Architect Iteration 4 ---
Timestamp: 2026-02-12T18:00:00Z
Tickets assigned: #253 → backend-engineer (orders audit writes, next in MVP-18 sequence)
Tickets completed: none (PR #382 still pending review)
Tickets blocked: none
Decisions made: ADR-005 (Migration Safety fix via migration-approved label)
Learnings:
  - PR #382 CI analysis: 4 failing checks, but 3 are pre-existing on main (kanban/orders/web unit tests)
  - Only PR-specific failure is "Migration Safety" — grep regex matches commented-out DROP in SQL rollback comments
  - Fix: add `migration-approved` label to PR #382 (low risk — the DROPs are SQL comments, not real DDL)
  - Alternative: backend-engineer removes commented rollback SQL from migration files
  - Main branch also fails: Integration Tests, kanban, orders, web — all pre-existing, not caused by PR #382
  - Lint & Typecheck now PASSING — the .default() fix from iteration 3 resolved all 30 TS2769 errors
  - All new test suites pass: db (78), auth-utils (9), auth-service, catalog-service, notifications
  - PR #382 is ready for review once Migration Safety is resolved
  - Next ticket: #253 (MVP-18/T4 — orders audit writes) can start on a branch off issue-251 while PR #382 awaits review

--- Backend Agent Iteration 4 | Issue #253 ---
Timestamp: 2026-02-12T22:00:00Z
Status: completed
Changes:
  Source files refactored (inline db.insert(auditLog) → writeAuditEntry):
  - services/orders/src/routes/purchase-orders.routes.ts (create PO/WO/TO audit writes)
  - services/orders/src/routes/order-queue.routes.ts (order-from-queue audit writes)
  - services/orders/src/services/receiving.service.ts (receipt.* audit writes)
  - services/orders/src/services/work-order-orchestration.service.ts (WO lifecycle audit writes)
  - services/orders/src/services/automation/action-handlers.ts (automation action audit writes)
  - services/orders/src/services/automation/orchestrator.ts (automation.decision_logged audit writes)
  New test files:
  - services/orders/src/routes/audit-refactor.integration.test.ts (6 tests — PO/WO/TO create + queue batch)
  - services/orders/src/services/audit-refactor-services.integration.test.ts (3 tests — receiving, WO orchestration, automation)
  Existing test files updated (added writeAuditEntry/writeAuditEntries to @arda/db mocks):
  - services/orders/src/routes/order-create-audit.integration.test.ts
  - services/orders/src/routes/order-mutation-audit.integration.test.ts
  - services/orders/src/routes/order-queue-risk.integration.test.ts
  - services/orders/src/routes/order-queue.integration.test.ts
  - services/orders/src/routes/order-status-events.integration.test.ts
  - services/orders/src/routes/purchase-orders.receive.events.integration.test.ts
  - services/orders/src/services/receiving-regression.test.ts
  - services/orders/src/services/automation/__tests__/resilience/action-handlers-fault-injection.test.ts
  - services/orders/src/services/automation/__tests__/resilience/orchestrator-fault-injection.test.ts
  - services/orders/src/services/automation/orchestrator.test.ts
Tests: 454 total passing (9 new + all existing), 0 failures. TypeScript typecheck clean.
Learnings:
  - When refactoring to writeAuditEntry, ALL test files mocking @arda/db must include writeAuditEntry/writeAuditEntries
  - Tests that assert audit behavior need writeAuditEntry mock that pushes to testState for inspection
  - Tests that don't assert audit behavior need a simple no-op writeAuditEntry mock to prevent import errors
  - Automation orchestrator/fault-injection tests used mockDbExecute for db.insert chain — must rename to mockWriteAuditEntry
  - order-queue-risk CTE query uses db.execute(sql`...`) — dbMock needs execute method, test data must match CTE column names (snake_case)
  - writeAuditEntry accepts DbOrTransaction — pass tx in transactional contexts, db for standalone calls
  - State-transition audit entries: capture previousState before mutation, newState after, both as JSON snapshots
  - System-initiated actions: userId: null, metadata.systemActor: 'automation-engine' (or similar)

--- Backend Agent Iteration 5 | Issue #253 ---
Timestamp: 2026-02-12T23:50:00Z
Status: completed
Changes:
  Remaining source files refactored (inline audit writes → writeAuditEntry):
  - services/orders/src/services/capacity-scheduler.service.ts (3 audit calls)
  - services/orders/src/services/completion-posting.service.ts (2 audit calls)
  - services/orders/src/services/routing-engine.service.ts (2 audit calls)
  - services/orders/src/services/production-exception.service.ts (3 audit calls, renamed scrap_rework → work_order.rework)
  - services/orders/src/services/material-consumption.service.ts (1 audit call)
  - services/orders/src/services/exception-automation.service.ts (3 audit calls, all system-initiated)
  - services/orders/src/services/inventory-ledger.service.ts (2 new FR-07 actions: inventory.adjusted, inventory.ledger_updated)
  - services/orders/src/routes/work-orders.routes.ts (4 helper functions)
  - services/orders/src/routes/transfer-orders.routes.ts (4 helper functions)
  - services/orders/src/routes/work-centers.routes.ts (1 helper function)
  Test files updated (9 existing + 1 new):
  - 9 existing test files: added writeAuditEntry/writeAuditEntries to @arda/db mocks
  - services/orders/src/services/audit-refactor-remaining.integration.test.ts (new — 8 tests)
Tests: 462 total passing (8 new + all existing), TypeScript clean. Only pre-existing perf test failure (needs DB).
Learnings:
  - Route files also had inline audit writes in helper functions (writeWorkOrderStatusAudit, etc.) — easy to miss
  - exception-automation.service.ts: all 3 audit calls are system-initiated (userId: null, systemActor: 'exception_automation')
  - production-exception.service.ts: renamed production_exception.scrap_rework → work_order.rework per FR-07
  - inventory-ledger.service.ts: needed 2 new actions (inventory.adjusted in adjustQuantity, inventory.ledger_updated in batchAdjust)
  - Test mock pattern for .returning().execute() chain: mock returning() to return object with execute() method
  - Drizzle insert chain: .values(...).returning({col}).execute() — the returning returns a builder, not a result
  - Zero inline db.insert(auditLog) / tx.insert(schema.auditLog) remain in non-test files after this iteration

--- Architect Iteration 5 ---
Timestamp: 2026-02-12T23:55:00Z
Tickets assigned: #254 (MVP-18/T5 — auth audit events), #255 (MVP-18/T6 — kanban audit writes)
Tickets completed: none (all 4 current tickets awaiting review)
Tickets blocked: none
Decisions made: ADR-006 (Continue MVP-18 T5-T6 while PRs await review)
Learnings:
  - PR #382 CI fully completed: Lint/Typecheck PASS, Security Gates PASS, all new suites PASS
  - PR #382 failures are all pre-existing on main: kanban, orders, web unit tests + Integration Tests
  - Only PR-specific failure: Migration Safety (needs migration-approved label per ADR-005)
  - PR #385 CI still running (Lint & Typecheck in progress), Security Gates all PASS
  - Both PRs are MERGEABLE — no conflicts
  - Backend-engineer idle after completing all 4 tickets — assigning T5 and T6 to keep momentum
  - T5 (#254) and T6 (#255) can be developed on branches off issue-253 without waiting for merges
  - Critical path: review and merge PR #382 → then PR #385 → then T5/T6 PRs

--- Backend Agent Iteration 6 | Issue #254 ---
Timestamp: 2026-02-13T03:05:00Z
Status: completed
Changes:
  New files:
  - services/auth/src/services/auth-audit.ts (centralized FR-05 action constants, redactSensitiveFields, writeAuthAuditEntry helper)
  - services/auth/src/services/auth-audit.test.ts (8 unit tests — action constants, redaction logic)
  - services/auth/src/services/auth-audit-integration.test.ts (11 integration tests — register, login, login_failed, invite, role change, deactivation, redaction, context propagation)
  Modified files:
  - services/auth/src/services/auth.service.ts (audit writes for register, login, login_failed, forgotPassword, resetPassword, refreshAccessToken, token replay, Google OAuth login/link/register)
  - services/auth/src/services/user-management.service.ts (audit writes for inviteUser, updateUserRole, deactivateUser with previousState/newState)
  - services/auth/src/routes/auth.routes.ts (extractAuditContext helper, audit context propagation to all service calls, logout audit write)
  - services/auth/src/routes/users.routes.ts (extractAuditContext, performedBy propagation)
  - 3 existing test files: added writeAuditEntry/writeAuditEntries to @arda/db mocks
Tests: 56 total passing (19 new + 37 existing), TypeScript clean. Build succeeds.
PR: https://github.com/khenson99/arda-v2/pull/386
Learnings:
  - Auth service functions accept optional `auditCtx?: AuthAuditContext` parameter (IP/UA/userId) — routes extract and pass through
  - For unauthenticated routes (login, register, etc.), extract IP/UA from req headers directly (no authMiddleware needed)
  - Failed login audit entries use userId: null — can't attribute to a user since credentials are invalid
  - Login with unknown email can't produce audit (no tenantId available) — document this gap
  - User management functions accept `performedBy` in input type to track the admin who performed the action
  - writeAuthAuditEntry wraps writeAuditEntry with automatic redactSensitiveFields on previousState/newState/metadata
  - Sensitive field set: password, passwordHash, token, tokenHash, refreshToken, accessToken, idToken, apiKey, keyHash, secret, webhookSecret, resetToken
  - Google OAuth has 3 audit paths: google_login (existing account), google_linked (email match, auto-link), google_registered (new account)
  - Auth service deactivated-account login failures produce audit with userId: null and reason: 'account_deactivated'
