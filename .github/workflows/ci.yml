name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# ─── Quality Gates ──────────────────────────────────────────────────
# Gate 1: Lint + Typecheck (fast fail — catches syntax/style issues)
# Gate 2: Unit tests (parallel per workspace)
# Gate 3: Coverage reporting (PR-only, target 60%)
# Gate 4: Security audit (npm audit — blocks on critical)
# Gate 5: Integration tests (requires DB/Redis)
# Gate 6: Migration safety check (PR-only, blocks destructive ops)
# Gate 7: Docker build matrix (main branch push only)
# ────────────────────────────────────────────────────────────────────

jobs:
  # ─── Gate 1: Lint & Typecheck ──────────────────────────────────────
  lint-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build packages (required for cross-package types)
        run: npx turbo build --filter='./packages/*'

      - name: Typecheck all workspaces
        run: npx turbo typecheck

      - name: Lint all workspaces
        run: npx turbo lint

  # ─── Gate 2: Unit Tests ────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint-typecheck

    strategy:
      fail-fast: false
      matrix:
        workspace:
          - '@arda/auth-utils'
          - '@arda/db'
          - '@arda/events'
          - '@arda/jobs'
          - '@arda/search'
          - '@arda/storage'
          - '@arda/observability'
          - '@arda/auth-service'
          - '@arda/catalog-service'
          - '@arda/kanban-service'
          - '@arda/notifications-service'
          - '@arda/orders-service'
          - '@arda/web'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npx turbo build --filter='./packages/*'

      - name: Run tests
        env:
          WORKSPACE: ${{ matrix.workspace }}
        run: npx turbo test --filter="$WORKSPACE"

  # ─── Gate 3: Coverage Report (PR only) ─────────────────────────────
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint-typecheck
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npx turbo build --filter='./packages/*'

      - name: Run tests with coverage
        run: npx turbo test:coverage
        continue-on-error: true

      - name: Generate coverage summary
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Statements | Branches | Functions | Lines |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|----------|-----------|-------|" >> $GITHUB_STEP_SUMMARY

          for dir in packages/*/coverage services/*/coverage; do
            if [ -f "$dir/coverage-summary.json" ]; then
              PKG=$(echo "$dir" | sed 's|/coverage||')
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('./$dir/coverage-summary.json', 'utf8'));
                const t = data.total;
                const name = '$PKG';
                const stmt = t.statements.pct + '%';
                const branch = t.branches.pct + '%';
                const func = t.functions.pct + '%';
                const lines = t.lines.pct + '%';
                console.log('| ' + name + ' | ' + stmt + ' | ' + branch + ' | ' + func + ' | ' + lines + ' |');
              " >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Target: 60% line coverage (enforced after stabilization phase)" >> $GITHUB_STEP_SUMMARY

  # ─── Gate 4: Security Audit ────────────────────────────────────────
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: lint-typecheck

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: npm audit (critical blocks, high warns)
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run audit and capture output
          set +e
          npm audit --audit-level=critical 2>&1
          AUDIT_EXIT=$?
          set -e

          if [ $AUDIT_EXIT -eq 0 ]; then
            echo "No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Critical vulnerabilities detected — review required before merge" >> $GITHUB_STEP_SUMMARY
            npm audit --audit-level=critical
          fi

      - name: Check high-severity (warning only)
        run: npm audit --audit-level=high || true

  # ─── Gate 5: Integration Tests ─────────────────────────────────────
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint-typecheck

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: arda_v2_test
          POSTGRES_USER: arda
          POSTGRES_PASSWORD: arda_test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U arda -d arda_v2_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://arda:arda_test_password@localhost:5432/arda_v2_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: test-jwt-secret-minimum-32-characters-long
      JWT_REFRESH_SECRET: test-jwt-refresh-secret-minimum-32-chars
      NODE_ENV: test

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build all
        run: npx turbo build

      - name: Push database schema
        run: npx turbo run db:push --filter=@arda/db
        continue-on-error: true

      - name: Run integration tests
        run: npx turbo test
        env:
          INTEGRATION: 'true'

  # ─── Gate 6: Migration Safety Check ────────────────────────────────
  migration-check:
    name: Migration Safety
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint-typecheck
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npx turbo build --filter='./packages/*'

      - name: Check for destructive migrations
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          echo "## Migration Safety Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find new/modified migration files vs base branch
          CHANGED_SQL=$(git diff --name-only --diff-filter=AM "$BASE_SHA" -- 'packages/db/drizzle/*.sql' || true)

          if [ -z "$CHANGED_SQL" ]; then
            echo "No new or modified migration files" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "### New/Modified Migrations" >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_SQL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for destructive operations
          DESTRUCTIVE_FOUND=false
          for f in $CHANGED_SQL; do
            if [ -f "$f" ]; then
              HITS=$(grep -inE "DROP TABLE|DROP COLUMN|TRUNCATE|DELETE FROM" "$f" || true)
              if [ -n "$HITS" ]; then
                DESTRUCTIVE_FOUND=true
                echo "Destructive ops in $f:" >> $GITHUB_STEP_SUMMARY
                echo "$HITS" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          if [ "$DESTRUCTIVE_FOUND" = true ]; then
            if [[ "$PR_LABELS" != *"migration-approved"* ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Missing migration-approved label — add it to proceed" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "migration-approved label present" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No destructive operations in migrations" >> $GITHUB_STEP_SUMMARY
          fi

  # ─── Gate 7: Docker Builds ─────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [unit-tests, integration-tests, security-audit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - auth
          - catalog
          - kanban
          - notifications
          - orders

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          build-args: SERVICE=${{ matrix.service }}
          tags: arda/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
